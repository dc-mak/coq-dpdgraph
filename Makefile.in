#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#            This file is part of the DpdGraph tools.
#  Copyright (C) 2009-2015 Anne Pacalet (Anne.Pacalet@free.fr)
#                      and Yves Bertot (Yves.Bertot@inria.fr)
#                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#      This file is distributed under the terms of the 
#       GNU Lesser General Public License Version 2.1
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.SUFFIXES:

ECHO=@echo
ECHO_CIBLE = $(ECHO) "   * build $@"

PRE=dpd

NAME=coq-dpdgraph
VERSION=$(shell cat VERSION)

BINDIR=@BINDIR@

DPDPLUGIN=./dpdgraph.cmxs ./dpdgraph.vo
DPD2DOT=./dpd2dot
DPD2=./dpd2
DPDUSAGE=./dpdusage

INCLUDES = -I @OCAMLGRAPH_PATH@

all : $(DPDPLUGIN) $(DPD2DOT) $(DPD2) $(DPDUSAGE)

DISTRIBUTED = $(PRE)_compute.ml $(PRE)_dot.ml \
	 $(PRE)_parse.mly  $(PRE)_lex.mll $(PRE)2dot.ml $(PRE)usage.ml

ML_COMMON = version.ml $(PRE)_compute.ml $(PRE)_dot.ml \
	 $(PRE)_csv.ml $(PRE)_parse.ml  $(PRE)_lex.ml
ML_DPD2DOT = $(PRE)2dot.ml
ML_DPD2 = $(PRE)2csv.ml
ML_DPDUSAGE = $(PRE)usage.ml

ML_ALL = $(ML_COMMON) $(ML_DPD2DOT) $(ML_DPD2) $(ML_DPDUSAGE)

CMOS_DPD2DOT=$(ML_COMMON:%.ml=%.cmo) $(ML_DPD2DOT:%.ml=%.cmo)
CMOS_DPD2=$(ML_COMMON:%.ml=%.cmo) $(ML_DPD2:%.ml=%.cmo)
CMOS_DPDUSAGE=$(ML_COMMON:%.ml=%.cmo) $(ML_DPDUSAGE:%.ml=%.cmo)
CMXS=$(ML_ALL:%.ml=%.cmx)

COQDEP=@OCAMLDEP@

OCAMLFLAGS =  -w Ael -warn-error -g -dtypes $(INCLUDES) -c
OCAMLOPTFLAGS = -c

COQEXTFILES=searchdepend.ml4 graphdepend.ml4

GENERATED+=$(COQEXTFILES:%.ml4=%.o) $(COQEXTFILES:%.ml4=%.cmx) dpdgraph.cmxs

DISTRIBUTED+=$(COQEXTFILES) dpdgraph.mllib
DISTRIBUTED+=Make

install : Make_coq
	$(MAKE) -f $< install
	cp dpd2dot dpdusage $(BINDIR)/

$(DPDPLUGIN) : Make_coq $(DISTRIBUTED)
	$(ECHO_CIBLE)
	$(MAKE) -f $< $@

Make_coq : Make
	$(ECHO_CIBLE)
	coq_makefile -f $< > $@

GENERATED+= Make_coq

version.ml : VERSION
	$(ECHO_CIBLE)
	$(ECHO) "(* This file is generated by Makefile. Do not modify. *)" > $@
	$(ECHO) "let version = \""$(VERSION)"\"" >> $@

GENERATED+=version.ml

$(DPD2DOT) : $(CMOS_DPD2DOT)
	$(ECHO_CIBLE)
	@OCAMLC@ -g $(INCLUDES) -o $@ graph.cma $(CMOS_DPD2DOT)

$(DPD2) : $(CMOS_DPD2)
	$(ECHO_CIBLE)
	@OCAMLC@ -g $(INCLUDES) -o $@ graph.cma $(CMOS_DPD2)

$(DPDUSAGE) : $(CMOS_DPDUSAGE)
	$(ECHO_CIBLE)
	@OCAMLC@ -g $(INCLUDES) -o $@ graph.cma $(CMOS_DPDUSAGE)

%.cmo : %.ml
	$(ECHO_CIBLE)
	@OCAMLC@ $(OCAMLFLAGS) $<

%.cmx : %.ml
	$(ECHO_CIBLE)
	@OCAMLOPT@ $(OPTPACKFLAGS) $(OCAMLOPTFLAGS) $<

%.cmi : %.mli
	$(ECHO_CIBLE)
	@OCAMLC@ $(OCAMLFLAGS) $<

%.ml : %.mll
	$(ECHO_CIBLE)
	@OCAMLLEX@ $<

GENERATED+=$(PRE)_lex.ml 

%.ml : %.mly
	$(ECHO_CIBLE)
	@OCAMLYACC@ $<

GENERATED+=$(PRE)_parse.ml $(PRE)_parse.mli

depend: .depend

.depend : $(ML_ALL) 
	$(ECHO_CIBLE)
	@OCAMLDEP@ $(ML_ALL) *.mli > $@

include .depend

GENERATED+=.depend

#-------------------------------------------------------------------------------
.PHONY: tests

TESTDIR=tests
TESTS_SRC=$(TESTDIR)/Morph.v $(TESTDIR)/Test.v $(TESTDIR)/Polymorph.v \
	  $(TESTDIR)/Morph.cmd $(TESTDIR)/Test.cmd $(TESTDIR)/search.cmd \
          $(TESTDIR)/Polymorph.cmd
TESTS_DPD=$(TESTDIR)/graph.dpd $(TESTDIR)/graph2.dpd \
	  $(TESTDIR)/Morph.dpd $(TESTDIR)/Morph_rw.dpd $(TESTDIR)/Polymorph.dpd
TESTS_DOT=$(TESTS_DPD:%.dpd=%.dot)
TESTS_CSV=$(TESTS_DPD:%.dpd=%.dot)
TESTS=$(TESTS_DPD) $(TESTS_DOT) $(TESTS_CSV) $(TESTDIR)/graph.without.dot \
      $(TESTDIR)/search  $(TESTDIR)/graph2.dpdusage
TESTS_LOG=$(TESTS:%=%.log)
TESTS_ORACLE=$(TESTS:%=%.oracle)
TESTS_OK=$(TESTS:%=%.ok)

DISTRIBUTED+=$(TESTS_SRC) $(TESTS_ORACLE)

.PRECIOUS : $(TESTS) $(TESTS_LOG) $(TESTS_ORACLE)

tests test : $(TESTS_OK)

$(TESTDIR)/%.dpdusage.log: $(TESTDIR)/%.dpd $(DPDUSAGE)
	$(DPDUSAGE) $< > $@

%.log : %
	cp $< $@

%.vo : %.v
	coqc -R . dpdgraph $<

%.html : %.v
	coqdoc $<

%.svg : %.dot
	dot -Tsvg -o$@ $<

%.dpd : %.vo %.cmd
	# cd to tests to generate .dpd file there.
	cd $(TESTDIR); coqtop -R .. dpdgraph < $(*F).cmd > /dev/null 2>&1

Morph%.dpd : $(TESTDIR)/Morph.vo $(TESTDIR)/Morph.cmd $(DPDPLUGIN)
	# cd to tests to generate .dpd file there.
	cd $(TESTDIR); coqtop -R .. dpdgraph < Morph.cmd > /dev/null 2>&1

Polymorph%.dpd : $(TESTDIR)/Polymorph.vo $(TESTDIR)/Polymorph.cmd $(DPDPLUGIN)
	cd $(TESTDIR); coqtop -R .. dpdgraph < Polymorph.cmd

graph%.dpd : $(TESTDIR)/Test.vo $(TESTDIR)/Test.cmd $(DPDPLUGIN)
	# cd to tests to generate .dpd file there.
	cd $(TESTDIR); coqtop -R .. dpdgraph < Test.cmd > /dev/null 2>&1

$(TESTDIR)/search.log : $(TESTDIR)/Test.vo $(TESTDIR)/search.cmd $(DPDPLUGIN)
	cat $(TESTDIR)/search.cmd | coqtop -R . dpdgraph 2> /dev/null \
	  | sed -e 's/Welcome to Coq.*/Welcome to Coq/' > $@

%.dot : %.dpd  $(DPD2DOT)
	$(DPD2DOT) $< > /dev/null

%.csv : %.dpd  $(DPD2)
	$(DPD2) $< > /dev/null

%.without.dot : %.dpd  $(DPD2DOT)
	$(DPD2DOT) -without-defs -o $@ $< > /dev/null

%.without.csv : %.dpd  $(DPD2)
	$(DPD2) -without-defs -o $@ $< > /dev/null

%.zgr : %.dot
	zgrviewer $<

%.ok : %.log %.oracle
	$(ECHO_CIBLE)
	@if diff $*.oracle $*.log > /dev/null ; then \
          echo "Bravo... Test [32mOk[0m" ; \
          touch $@ ; \
        else \
          echo "[31mDIFFERENCES[0m : diff $*.oracle $*.log" ; \
          echo "To force a new execution of the test:" ; \
	  echo "  rm $*.log ; make $*.ok"; \
          echo "[31mTo accept the results[0m: " ; \
          echo "  cp $*.log $*.oracle" ; \
          rm -f $@ ; \
        fi

# oracle is updated by user, but one is needed the first time
%.oracle :
	$(ECHO_CIBLE) "[ATTENTION : automatic generation of $@]"
	$(MAKE) $*.log
	cp $*.log $*.oracle

#-------------------------------------------------------------------------------
DISTRIBUTED+=Makefile LICENSE README.md VERSION

distrib : $(NAME)-$(VERSION).tgz

%.tgz : clean
	$(ECHO_CIBLE)
	rm -rf $* $@
	mkdir $*
	cp --parents $(DISTRIBUTED) $*
	tar zcvf $@ $*
	rm -rf $*
	@ echo "Don't forget to copy README.md and $@ on the server if needed"


#-------------------------------------------------------------------------------
clean_coq : Make_coq
	$(MAKE) -f $< clean

clean_test :
	rm -f $(TESTS) $(TESTS_LOG) $(TESTS_OK) 
	rm -f $(TESTDIR)/Test.vo  $(TESTDIR)/Test.glob
	rm -f $(TESTDIR)/Morph.vo  $(TESTDIR)/Morph.glob

clean : clean_coq clean_test
	rm -f $(GENERATED) 
	rm -f $(CMOS_DPDUSAGE) $(CMOS_DPD2DOT) $(CMOS_DPD2) $(CMXS) $(ML_ALL:%.ml=%.o) *.cmi
	rm -f $(ML_ALL:%.ml=%.annot)
	rm -f $(DPD2DOT) $(DPD2) $(DPDUSAGE) $(DPDPLUGIN)

